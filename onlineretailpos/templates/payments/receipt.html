{% extends 'base.html' %}
{% load static %}

{% block title %}Receipt - {{ block.super }}{% endblock %}

{% block extra_head %}
<style>
    .receipt-container {
        max-width: 400px;
        margin: 20px auto;
        font-family: 'Courier New', monospace;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .receipt-paper {
        background: white;
        padding: 20px;
        position: relative;
    }

    .receipt-header {
        text-align: center;
        border-bottom: 2px dashed #333;
        padding-bottom: 15px;
        margin-bottom: 15px;
    }

    .store-logo {
        width: 60px;
        height: 60px;
        background: #007bff;
        border-radius: 50%;
        margin: 0 auto 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        font-weight: bold;
    }

    .store-name {
        font-size: 18px;
        font-weight: bold;
        margin: 5px 0;
        text-transform: uppercase;
    }

    .store-address {
        font-size: 12px;
        color: #666;
        line-height: 1.4;
    }

    .receipt-details {
        margin: 15px 0;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 2px 0;
        font-size: 12px;
    }

    .detail-row.bold {
        font-weight: bold;
        border-top: 1px dashed #333;
        padding-top: 8px;
        margin-top: 8px;
    }

    .item-line {
        display: flex;
        justify-content: space-between;
        padding: 3px 0;
        font-size: 12px;
    }

    .item-line.total {
        border-top: 2px dashed #333;
        border-bottom: 1px solid #333;
        padding: 8px 0;
        margin-top: 10px;
        font-weight: bold;
        font-size: 14px;
    }

    .payment-info {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px dashed #333;
    }

    .receipt-footer {
        text-align: center;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 2px dashed #333;
        font-size: 10px;
        color: #666;
    }

    .qr-code {
        width: 80px;
        height: 80px;
        background: #f8f9fa;
        border: 1px solid #ddd;
        margin: 10px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #999;
    }

    .receipt-actions {
        padding: 20px;
        background: #f8f9fa;
        text-align: center;
        border-top: 1px solid #e9ecef;
    }

    .action-btn {
        margin: 5px;
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
    }

    .btn-print {
        background: #007bff;
        color: white;
    }

    .btn-print:hover {
        background: #0056b3;
        transform: translateY(-1px);
    }

    .btn-email {
        background: #28a745;
        color: white;
    }

    .btn-email:hover {
        background: #1e7e34;
        transform: translateY(-1px);
    }

    .btn-download {
        background: #6c757d;
        color: white;
    }

    .btn-download:hover {
        background: #545b62;
        transform: translateY(-1px);
    }

    .btn-back {
        background: #ffc107;
        color: #212529;
    }

    .btn-back:hover {
        background: #e0a800;
        transform: translateY(-1px);
    }

    /* Print styles */
    @media print {
        body * {
            visibility: hidden;
        }
        
        .receipt-container,
        .receipt-container * {
            visibility: visible;
        }
        
        .receipt-container {
            position: absolute;
            left: 0;
            top: 0;
            margin: 0;
            box-shadow: none;
            border-radius: 0;
        }
        
        .receipt-actions {
            display: none;
        }
        
        .receipt-paper {
            padding: 10px;
        }
    }

    /* Mobile-First Responsive Design */
    @media (max-width: 992px) {
        .receipt-container {
            margin: 15px;
            max-width: 500px;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn {
            padding: 12px 20px;
            font-size: 1rem;
            min-height: 45px;
            width: 100%;
        }
    }

    @media (max-width: 768px) {
        .receipt-container {
            margin: 10px;
            max-width: none;
            border-radius: 8px;
        }
        
        .receipt-paper {
            padding: 15px;
        }
        
        .store-logo {
            width: 50px;
            height: 50px;
            font-size: 20px;
        }
        
        .store-name {
            font-size: 16px;
        }
        
        .store-address {
            font-size: 11px;
        }
        
        .detail-row {
            font-size: 11px;
            padding: 3px 0;
        }
        
        .item-line {
            font-size: 11px;
            padding: 4px 0;
        }
        
        .item-line.total {
            font-size: 13px;
            padding: 10px 0;
        }
        
        .action-btn {
            padding: 15px;
            font-size: 1.1rem;
            min-height: 50px;
            touch-action: manipulation;
            border-radius: 8px;
        }
        
        .qr-code {
            width: 120px;
            height: 120px;
        }
        
        .receipt-footer {
            font-size: 10px;
        }
    }

    @media (max-width: 576px) {
        .receipt-container {
            margin: 5px;
            border-radius: 6px;
        }
        
        .receipt-paper {
            padding: 12px;
        }
        
        .store-logo {
            width: 45px;
            height: 45px;
            font-size: 18px;
        }
        
        .store-name {
            font-size: 15px;
        }
        
        .store-address {
            font-size: 10px;
        }
        
        .detail-row {
            font-size: 10px;
        }
        
        .item-line {
            font-size: 10px;
        }
        
        .item-line.total {
            font-size: 12px;
        }
        
        .action-btn {
            padding: 18px;
            font-size: 1rem;
            min-height: 55px;
            border-radius: 10px;
        }
        
        .qr-code {
            width: 100px;
            height: 100px;
        }
        
        .receipt-footer {
            font-size: 9px;
            line-height: 1.3;
        }
    }
    
    @media (max-width: 480px) {
        .receipt-paper {
            padding: 10px;
        }
        
        .action-btn {
            padding: 20px;
            font-size: 1.1rem;
            min-height: 60px;
        }
        
        .store-logo {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }
        
        .qr-code {
            width: 80px;
            height: 80px;
        }
    }
    
    /* Touch-friendly enhancements */
    .action-btn:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
    }
    
    .action-btn {
        transition: all 0.2s ease;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
    }
    
    /* Mobile-specific styles */
    @media (hover: none) and (pointer: coarse) {
        .action-btn:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }
    }
    
    /* Better mobile sharing styles */
    @media (max-width: 768px) {
        .share-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .share-btn {
            padding: 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            color: #333;
            touch-action: manipulation;
        }
        
        .share-btn:hover,
        .share-btn:active {
            background: #f8f9fa;
            text-decoration: none;
            color: #333;
        }
        
        .share-btn i {
            font-size: 1.1rem;
        }
    }
    
    /* Orientation-specific adjustments */
    @media (max-width: 768px) and (orientation: landscape) {
        .receipt-container {
            max-width: 400px;
            margin: 10px auto;
        }
        
        .action-buttons {
            flex-direction: row;
            flex-wrap: wrap;
        }
        
        .action-btn {
            flex: 1;
            min-width: 120px;
            margin: 5px;
        }
        
        .store-logo {
            width: 35px;
            height: 35px;
            font-size: 14px;
        }
        
        .qr-code {
            width: 70px;
            height: 70px;
        }
    }

    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
    }

    .status-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-pending {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .status-failed {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>
{% endblock %}

{% block content %}
<div class="receipt-container">
    <!-- Receipt Paper -->
    <div class="receipt-paper" id="receiptContent">
        <!-- Store Header -->
        <div class="receipt-header">
            <div class="store-logo">
                <i class="fas fa-cash-register"></i>
            </div>
            <div class="store-name">{{ store_name|default:"Ireti POS" }}</div>
            <div class="store-address">
                {{ store_address|default:"123 Main Street<br>City, State 12345<br>(555) 123-4567" }}
            </div>
        </div>

        <!-- Transaction Details -->
        <div class="receipt-details">
            <div class="detail-row">
                <span>Receipt #:</span>
                <span>{{ receipt_number|default:"RCP-000001" }}</span>
            </div>
            <div class="detail-row">
                <span>Date:</span>
                <span>{{ transaction_date|date:"M d, Y" }}</span>
            </div>
            <div class="detail-row">
                <span>Time:</span>
                <span>{{ transaction_date|time:"g:i A" }}</span>
            </div>
            <div class="detail-row">
                <span>Cashier:</span>
                <span>{{ cashier_name|default:user.username }}</span>
            </div>
            <div class="detail-row">
                <span>Customer:</span>
                <span>{{ customer_name|default:"Guest" }}</span>
            </div>
            {% if transaction_id %}
            <div class="detail-row">
                <span>Transaction:</span>
                <span>{{ transaction_id|truncatechars:12 }}</span>
            </div>
            {% endif %}
        </div>

        <!-- Items -->
        <!-- Items -->
        <div class="receipt-items">
        {% for item in items %}
            <div class="item-line">
                <span>{{ item.name|truncatechars:25 }}</span>
                <span>${{ item.amount|floatformat:2 }}</span>
            </div>
            {% if item.quantity and item.quantity > 1 %}
                <div class="item-line" style="font-size: 10px; color: #666; padding-left: 10px;">
                    <span>{{ item.quantity }} x ${{ item.unit_price|floatformat:2 }}</span>
                    <span></span>
                </div>
            {% endif %}
        {% empty %}
            <div class="item-line">
                <span>No items</span>
                <span>$0.00</span>
            </div>
        {% endfor %}
        </div>

        <!-- Totals Section -->
        <div class="receipt-totals">
            <!-- Subtotal -->
            <div class="item-line" style="margin-top: 10px;">
                <span>Subtotal:</span>
                <span>${{ subtotal|floatformat:2 }}</span>
            </div>
            
            <!-- Tax -->
            {% if tax_amount and tax_amount > 0 %}
            <div class="item-line">
                <span>Tax ({{ tax_rate|floatformat:1 }}%):</span>
                <span>${{ tax_amount|floatformat:2 }}</span>
            </div>
            {% endif %}
            
            <!-- Tip -->
            {% if tip_amount and tip_amount > 0 %}
            <div class="item-line">
                <span>Tip:</span>
                <span>${{ tip_amount|floatformat:2 }}</span>
            </div>
            {% endif %}
            
            <!-- Total -->
            <div class="item-line total">
                <span>TOTAL:</span>
                <span>${{ total_amount|floatformat:2 }}</span>
            </div>
        </div>

        <!-- Payment Information -->
        <div class="payment-info">
            <div class="detail-row">
                <span>Payment Method:</span>
                <span>{{ payment_method|default:"Card" }}</span>
            </div>
            {% if payment_id %}
            <div class="detail-row">
                <span>Payment ID:</span>
                <span>{{ payment_id|truncatechars:20 }}</span>
            </div>
            {% endif %}
            <div class="detail-row">
                <span>Status:</span>
                <span class="status-badge status-{{ payment_status|default:'success' }}">
                    {{ payment_status|default:'Success'|title }}
                </span>
            </div>
            {% if card_last_four %}
            <div class="detail-row">
                <span>Card:</span>
                <span>****{{ card_last_four }}</span>
            </div>
            {% endif %}
            {% if authorization_code %}
            <div class="detail-row">
                <span>Auth Code:</span>
                <span>{{ authorization_code }}</span>
            </div>
            {% endif %}
        </div>

        <!-- Footer -->
        <div class="receipt-footer">
            <div>Thank you for your business!</div>
            {% if return_policy %}
            <div style="margin-top: 10px;">
                <strong>Return Policy:</strong><br>
                {{ return_policy }}
            </div>
            {% endif %}
            
            <!-- QR Code for digital receipt -->
            {% if receipt_url %}
            <div class="qr-code">
                QR CODE<br>
                <small>Digital Receipt</small>
            </div>
            {% endif %}
            
            <div style="margin-top: 15px; font-size: 8px;">
                {{ store_name|default:"Ireti POS" }} â€¢ Powered by Stripe
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="receipt-actions">
        <button onclick="printReceipt()" class="action-btn btn-print">
            <i class="fas fa-print"></i> Print Receipt
        </button>
        <button onclick="emailReceipt()" class="action-btn btn-email">
            <i class="fas fa-envelope"></i> Email Receipt
        </button>
        <button onclick="downloadReceipt()" class="action-btn btn-download">
            <i class="fas fa-download"></i> Download PDF
        </button>
        <a href="{% url 'payments:payment_form' %}" class="action-btn btn-back">
            <i class="fas fa-arrow-left"></i> New Transaction
        </a>
    </div>
</div>

<!-- Email Receipt Modal -->
<div class="modal fade" id="emailModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Email Receipt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="emailForm">
                    <div class="mb-3">
                        <label class="form-label">Email Address:</label>
                        <input type="email" class="form-control" id="emailInput" 
                               value="{{ customer_email }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message (Optional):</label>
                        <textarea class="form-control" rows="2" id="messageInput"
                                  placeholder="Thank you for your purchase!"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendEmail()">Send Receipt</button>
            </div>
        </div>
    </div>
</div>

<script>
function printReceipt() {
    // Use browser's print functionality
    window.print();
}

function emailReceipt() {
    // Show email modal
    const emailModal = new bootstrap.Modal(document.getElementById('emailModal'));
    emailModal.show();
}

async function sendEmail() {
    const email = document.getElementById('emailInput').value;
    const message = document.getElementById('messageInput').value;
    
    if (!email) {
        alert('Please enter an email address');
        return;
    }
    
    try {
        // TODO: Implement email sending via API
        const response = await fetch('/payments/api/receipt/email/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({
                transaction_id: '{{ transaction_id }}',
                email: email,
                message: message
            })
        });
        
        if (response.ok) {
            alert('Receipt sent successfully!');
            bootstrap.Modal.getInstance(document.getElementById('emailModal')).hide();
        } else {
            alert('Failed to send receipt. Please try again.');
        }
    } catch (error) {
        console.error('Error sending email:', error);
        alert('Network error. Please try again.');
    }
}

function downloadReceipt() {
    // Generate PDF using browser's print to PDF or implement server-side PDF generation
    try {
        // For now, trigger print dialog with suggestion to save as PDF
        if (window.navigator.userAgent.includes('Chrome')) {
            // Chrome users can save as PDF from print dialog
            window.print();
        } else {
            // For other browsers, could implement server-side PDF generation
            alert('PDF download feature coming soon! Use Print for now.');
        }
    } catch (error) {
        console.error('Error downloading receipt:', error);
        alert('Download failed. Please try printing instead.');
    }
}

// Auto-print for thermal printers if configured
document.addEventListener('DOMContentLoaded', function() {
    const autoPrint = '{{ auto_print|yesno:"true,false" }}';
    if (autoPrint === 'true') {
        setTimeout(() => {
            window.print();
        }, 1000);
    }
    
    // Initialize mobile enhancements
    setupReceiptMobileEnhancements();
});

// Mobile-specific enhancements for receipt page
function setupReceiptMobileEnhancements() {
    // Add mobile sharing capabilities
    addMobileSharingOptions();
    
    // Setup touch feedback for action buttons
    const actionButtons = document.querySelectorAll('.action-btn, .share-btn');
    actionButtons.forEach(button => {
        button.addEventListener('touchstart', function(e) {
            this.style.transform = 'scale(0.98)';
            
            // Add haptic feedback if available
            if ('vibrate' in navigator) {
                navigator.vibrate(10);
            }
        }, { passive: true });
        
        button.addEventListener('touchend', function() {
            this.style.transform = '';
        }, { passive: true });
    });
    
    // Enhanced print functionality for mobile
    const printBtn = document.querySelector('[onclick*="print"]');
    if (printBtn) {
        printBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (window.innerWidth <= 768) {
                // Mobile print handling
                if ('print' in window) {
                    window.print();
                } else {
                    showMobileAlert('Print not available. Try sharing or saving instead.');
                }
            } else {
                window.print();
            }
        });
    }
    
    // Add QR code touch handling for better mobile interaction
    const qrCode = document.querySelector('.qr-code');
    if (qrCode) {
        qrCode.style.cursor = 'pointer';
        qrCode.addEventListener('click', function() {
            // Show enlarged QR code on mobile
            if (window.innerWidth <= 768) {
                showEnlargedQR(this.src);
            }
        });
    }
    
    console.log('Mobile enhancements initialized for receipt page');
}

// Add mobile sharing options
function addMobileSharingOptions() {
    const receiptContainer = document.querySelector('.receipt-container');
    if (!receiptContainer || window.innerWidth > 768) return;
    
    // Create mobile share section
    const shareSection = document.createElement('div');
    shareSection.className = 'share-options';
    shareSection.innerHTML = `
        <a href="#" class="share-btn" onclick="shareReceipt(event)">
            <i class="fas fa-share-alt"></i>
            Share
        </a>
        <a href="#" class="share-btn" onclick="downloadReceipt(event)">
            <i class="fas fa-download"></i>
            Save
        </a>
        <a href="#" class="share-btn" onclick="emailReceipt(event)">
            <i class="fas fa-envelope"></i>
            Email
        </a>
        <a href="#" class="share-btn" onclick="copyReceiptLink(event)">
            <i class="fas fa-link"></i>
            Copy Link
        </a>
    `;
    
    // Insert share section after receipt paper
    const receiptPaper = document.querySelector('.receipt-paper');
    receiptPaper.appendChild(shareSection);
}

// Mobile sharing functions
function shareReceipt(e) {
    e.preventDefault();
    
    if (navigator.share) {
        navigator.share({
            title: 'Payment Receipt',
            text: 'Receipt for payment transaction',
            url: window.location.href
        }).catch(err => console.log('Error sharing:', err));
    } else {
        copyReceiptLink(e);
    }
}

function downloadReceipt(e) {
    e.preventDefault();
    
    // Use html2canvas or similar library if available, otherwise fallback to print
    if (window.html2canvas) {
        const receipt = document.querySelector('.receipt-paper');
        html2canvas(receipt).then(canvas => {
            const link = document.createElement('a');
            link.download = 'receipt.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    } else {
        window.print();
    }
}

function emailReceipt(e) {
    e.preventDefault();
    
    const subject = 'Payment Receipt';
    const body = 'Please find your payment receipt at: ' + window.location.href;
    const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    
    window.location.href = mailto;
}

function copyReceiptLink(e) {
    e.preventDefault();
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(window.location.href).then(() => {
            showMobileAlert('Receipt link copied to clipboard!');
        });
    } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = window.location.href;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showMobileAlert('Receipt link copied!');
    }
}

// Show enlarged QR code on mobile
function showEnlargedQR(qrSrc) {
    const overlay = document.createElement('div');
    overlay.className = 'qr-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        cursor: pointer;
    `;
    
    const qrImage = document.createElement('img');
    qrImage.src = qrSrc;
    qrImage.style.cssText = `
        max-width: 300px;
        max-height: 300px;
        background: white;
        padding: 20px;
        border-radius: 10px;
    `;
    
    overlay.appendChild(qrImage);
    document.body.appendChild(overlay);
    
    overlay.addEventListener('click', () => {
        document.body.removeChild(overlay);
    });
}

// Mobile alert system
function showMobileAlert(message) {
    const alert = document.createElement('div');
    alert.className = 'mobile-receipt-alert';
    alert.style.cssText = `
        position: fixed;
        top: 20px;
        left: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        z-index: 10001;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease-out;
    `;
    
    alert.textContent = message;
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => document.body.removeChild(alert), 300);
    }, 2500);
}
</script>
{% endblock %}
