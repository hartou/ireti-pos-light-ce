{% extends 'base_admin.html' %}
{% load static %}
{% load i18n %}

{% block page_title %}{% trans "Payment History" %}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'payments:dashboard' %}">{% trans "Payments" %}</a></li>
<li class="breadcrumb-item active" aria-current="page">{% trans "History" %}</li>
{% endblock %}

{% block extra_css %}
<style>
    .payment-history-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .history-header {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .history-title {
        color: #2c3e50;
        margin: 0 0 10px 0;
        font-size: 1.8rem;
        font-weight: 600;
    }
    
    .history-subtitle {
        color: #7f8c8d;
        margin: 0;
        font-size: 1rem;
    }
    
    .filters-section {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .filter-row {
        display: flex;
        gap: 15px;
        align-items: end;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 150px;
    }
    
    .filter-group label {
        font-weight: 500;
        color: #2c3e50;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    
    .filter-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    
    .filter-input:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    .filter-buttons {
        display: flex;
        gap: 10px;
    }
    
    .btn-filter {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-primary {
        background: #3498db;
        color: white;
    }
    
    .btn-primary:hover {
        background: #2980b9;
    }
    
    .btn-secondary {
        background: #95a5a6;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #7f8c8d;
    }
    
    .history-table-container {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .history-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .history-table th {
        background: #34495e;
        color: white;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 0.9rem;
        border-bottom: 2px solid #2c3e50;
    }
    
    .history-table td {
        padding: 12px;
        border-bottom: 1px solid #ecf0f1;
        font-size: 0.9rem;
    }
    
    .history-table tbody tr:hover {
        background: #f8f9fa;
        cursor: pointer;
    }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .status-success {
        background: #d4edda;
        color: #155724;
    }
    
    .status-pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-failed {
        background: #f8d7da;
        color: #721c24;
    }
    
    .status-refunded {
        background: #cce7ff;
        color: #004085;
    }
    
    .amount-cell {
        text-align: right;
        font-weight: 600;
        color: #27ae60;
    }
    
    .amount-negative {
        color: #e74c3c;
    }
    
    .date-cell {
        color: #7f8c8d;
        font-size: 0.85rem;
    }
    
    .customer-cell {
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .transaction-id {
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
        color: #7f8c8d;
    }
    
    .actions-cell {
        white-space: nowrap;
    }
    
    .btn-action {
        padding: 4px 8px;
        margin: 0 2px;
        border: none;
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: all 0.2s;
    }
    
    .btn-view {
        background: #3498db;
        color: white;
    }
    
    .btn-view:hover {
        background: #2980b9;
        color: white;
    }
    
    .btn-receipt {
        background: #f39c12;
        color: white;
    }
    
    .btn-receipt:hover {
        background: #e67e22;
        color: white;
    }
    
    .btn-refund {
        background: #e74c3c;
        color: white;
    }
    
    .btn-refund:hover {
        background: #c0392b;
        color: white;
    }
    
    .pagination {
        padding: 20px;
        text-align: center;
        background: #fff;
        border-top: 1px solid #ecf0f1;
    }
    
    .pagination .btn {
        margin: 0 5px;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        color: #2c3e50;
        text-decoration: none;
        cursor: pointer;
    }
    
    .pagination .btn:hover {
        background: #f8f9fa;
    }
    
    .pagination .btn.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }
    
    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
    }
    
    .stat-label {
        color: #7f8c8d;
        margin: 5px 0 0 0;
        font-size: 0.9rem;
    }
    
    .stat-success { color: #27ae60; }
    .stat-pending { color: #f39c12; }
    .stat-failed { color: #e74c3c; }
    .stat-total { color: #3498db; }
    
    .no-transactions {
        text-align: center;
        padding: 40px 20px;
        color: #7f8c8d;
    }
    
    .no-transactions i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #bdc3c7;
    }
    
    /* Mobile-First Comprehensive Responsive Design */
    @media (max-width: 1200px) {
        .filter-row {
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filter-group {
            min-width: 200px;
        }
        
        .export-buttons {
            flex-wrap: wrap;
            gap: 8px;
        }
    }

    @media (max-width: 992px) {
        .summary-stats {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat-card {
            padding: 15px;
        }
        
        .stat-number {
            font-size: 1.5rem;
        }
        
        .filter-row {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }
        
        .filter-group {
            min-width: auto;
        }
        
        .history-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
        }
        
        .history-table {
            min-width: 800px;
        }
        
        .export-section {
            flex-direction: column;
            align-items: stretch;
            text-align: center;
        }
        
        .export-buttons {
            justify-content: center;
            margin-top: 15px;
        }
    }

    @media (max-width: 768px) {
        .filter-row {
            flex-direction: column;
            align-items: stretch;
        }
        
        .filter-group {
            min-width: auto;
        }
        
        .filter-group input,
        .filter-group select {
            font-size: 16px; /* Prevents zoom on iOS */
            padding: 12px;
            min-height: 44px; /* Touch-friendly minimum */
        }
        
        .btn-filter {
            padding: 12px 20px;
            font-size: 1rem;
            min-height: 44px;
            touch-action: manipulation;
        }
        
        .history-table-container {
            overflow-x: auto;
            margin: 0 -15px; /* Full width scroll */
            padding: 0 15px;
        }
        
        .history-table {
            min-width: 700px;
            font-size: 0.85rem;
        }
        
        .history-table th,
        .history-table td {
            padding: 8px 6px;
        }
        
        .summary-stats {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .stat-card {
            padding: 12px;
        }
        
        .stat-number {
            font-size: 1.3rem;
        }
        
        .stat-label {
            font-size: 0.8rem;
        }
        
        .export-section {
            padding: 12px 15px;
        }
        
        .export-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        
        .btn-export {
            padding: 10px 8px;
            font-size: 0.85rem;
            text-align: center;
        }
        
        /* Mobile Card Layout for transactions */
        .mobile-transaction-cards {
            display: none;
        }
        
        .mobile-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        
        .mobile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        
        .mobile-card-amount {
            font-size: 1.3rem;
            font-weight: bold;
            color: #007bff;
        }
        
        .mobile-card-date {
            font-size: 0.85rem;
            color: #666;
        }
        
        .mobile-card-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .mobile-card-detail {
            font-size: 0.85rem;
        }
        
        .mobile-card-detail strong {
            color: #333;
        }
        
        .mobile-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .mobile-card-btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.85rem;
            border: 1px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 4px;
            text-decoration: none;
            text-align: center;
            touch-action: manipulation;
        }
        
        .mobile-card-btn:hover,
        .mobile-card-btn:active {
            background: #007bff;
            color: white;
            text-decoration: none;
        }
    }

    @media (max-width: 576px) {
        .summary-stats {
            grid-template-columns: 1fr 1fr;
        }
        
        .stat-card {
            padding: 10px;
        }
        
        .stat-number {
            font-size: 1.2rem;
        }
        
        .stat-label {
            font-size: 0.75rem;
        }
        
        .filter-group input,
        .filter-group select {
            padding: 15px 12px;
            font-size: 16px;
            border-radius: 8px;
        }
        
        .btn-filter {
            padding: 15px 20px;
            font-size: 1.1rem;
            min-height: 50px;
            border-radius: 8px;
        }
        
        .export-buttons {
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .btn-export {
            padding: 12px 10px;
            font-size: 0.9rem;
            min-height: 44px;
        }
        
        /* Switch to card layout on small screens */
        .history-table-container {
            display: none;
        }
        
        .mobile-transaction-cards {
            display: block;
        }
        
        .mobile-card {
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .mobile-card-amount {
            font-size: 1.2rem;
        }
        
        .mobile-card-details {
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .mobile-card-btn {
            padding: 10px;
            font-size: 0.9rem;
            min-height: 40px;
        }
        
        .pagination {
            justify-content: center;
        }
        
        .pagination .page-link {
            padding: 10px 15px;
            font-size: 0.9rem;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    }
    
    @media (max-width: 480px) {
        .summary-stats {
            grid-template-columns: 1fr;
        }
        
        .mobile-card-header {
            flex-direction: column;
            align-items: start;
            gap: 5px;
        }
        
        .mobile-card-actions {
            flex-direction: column;
        }
        
        .mobile-card-btn {
            padding: 12px;
            font-size: 1rem;
        }
        
        .export-buttons {
            grid-template-columns: 1fr;
        }
    }
    
    /* Touch and interaction enhancements */
    .btn-filter:active,
    .btn-export:active,
    .mobile-card-btn:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
    }
    
    /* Prevent text selection on interactive elements */
    .btn,
    .mobile-card-btn,
    .page-link {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
    }
    
    /* Swipe-to-refresh indicator */
    .mobile-refresh-indicator {
        display: none;
        text-align: center;
        padding: 10px;
        color: #007bff;
        font-size: 0.9rem;
    }
    
    @media (max-width: 768px) {
        .mobile-refresh-indicator {
            display: block;
        }
    }
    
    .export-section {
        background: #fff;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .export-buttons {
        display: flex;
        gap: 10px;
    }
    
    .btn-export {
        padding: 8px 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        color: #2c3e50;
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .btn-export:hover {
        background: #f8f9fa;
        border-color: #3498db;
        color: #3498db;
        text-decoration: none;
    }
</style>
{% endblock %}

{% block admin_content %}
<div class="payment-history-container">
    <!-- Header -->
    <div class="history-header">
        <h1 class="history-title">{% trans "Payment History" %}</h1>
        <p class="history-subtitle">{% trans "View and manage all payment transactions" %}</p>
    </div>
    
    <!-- Summary Statistics -->
    <div class="summary-stats">
        <div class="stat-card">
            <div class="stat-value stat-total">{{ stats.total_transactions|default:"0" }}</div>
            <div class="stat-label">{% trans "Total Transactions" %}</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-success">${{ stats.total_amount|default:"0.00"|floatformat:2 }}</div>
            <div class="stat-label">{% trans "Total Amount" %}</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-success">{{ stats.successful_payments|default:"0" }}</div>
            <div class="stat-label">{% trans "Successful" %}</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-failed">{{ stats.failed_payments|default:"0" }}</div>
            <div class="stat-label">{% trans "Failed" %}</div>
        </div>
    </div>
    
    <!-- Export Section -->
    <div class="export-section">
        <div>
            <strong>{% trans "Export Data" %}:</strong>
            <span class="text-muted">{% trans "Download transaction history" %}</span>
        </div>
        <div class="export-buttons">
            <a href="?export=csv" class="btn-export">
                <i class="fas fa-file-csv"></i> {% trans "CSV" %}
            </a>
            <a href="?export=excel" class="btn-export">
                <i class="fas fa-file-excel"></i> {% trans "Excel" %}
            </a>
            <a href="?export=pdf" class="btn-export">
                <i class="fas fa-file-pdf"></i> {% trans "PDF Report" %}
            </a>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="filters-section">
        <form method="GET" id="historyFilters">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="date_from">{% trans "From Date" %}</label>
                    <input type="date" id="date_from" name="date_from" class="filter-input" 
                           value="{{ filters.date_from|default:'' }}">
                </div>
                <div class="filter-group">
                    <label for="date_to">{% trans "To Date" %}</label>
                    <input type="date" id="date_to" name="date_to" class="filter-input" 
                           value="{{ filters.date_to|default:'' }}">
                </div>
                <div class="filter-group">
                    <label for="status">{% trans "Status" %}</label>
                    <select id="status" name="status" class="filter-input">
                        <option value="">{% trans "All Statuses" %}</option>
                        <option value="succeeded" {% if filters.status == 'succeeded' %}selected{% endif %}>
                            {% trans "Success" %}
                        </option>
                        <option value="pending" {% if filters.status == 'pending' %}selected{% endif %}>
                            {% trans "Pending" %}
                        </option>
                        <option value="failed" {% if filters.status == 'failed' %}selected{% endif %}>
                            {% trans "Failed" %}
                        </option>
                        <option value="canceled" {% if filters.status == 'canceled' %}selected{% endif %}>
                            {% trans "Canceled" %}
                        </option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="amount_min">{% trans "Min Amount" %}</label>
                    <input type="number" id="amount_min" name="amount_min" class="filter-input" 
                           step="0.01" placeholder="0.00" value="{{ filters.amount_min|default:'' }}">
                </div>
                <div class="filter-group">
                    <label for="amount_max">{% trans "Max Amount" %}</label>
                    <input type="number" id="amount_max" name="amount_max" class="filter-input" 
                           step="0.01" placeholder="999.99" value="{{ filters.amount_max|default:'' }}">
                </div>
            </div>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="search">{% trans "Search" %}</label>
                    <input type="text" id="search" name="search" class="filter-input" 
                           placeholder="{% trans 'Customer name, email, or transaction ID' %}" 
                           value="{{ filters.search|default:'' }}">
                </div>
                <div class="filter-buttons">
                    <button type="submit" class="btn-filter btn-primary">
                        <i class="fas fa-search"></i> {% trans "Filter" %}
                    </button>
                    <a href="?" class="btn-filter btn-secondary">
                        <i class="fas fa-times"></i> {% trans "Clear" %}
                    </a>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Transaction Table -->
    <div class="history-table-container">
        {% if transactions %}
        <table class="history-table">
            <thead>
                <tr>
                    <th>{% trans "Date" %}</th>
                    <th>{% trans "Transaction ID" %}</th>
                    <th>{% trans "Customer" %}</th>
                    <th>{% trans "Amount" %}</th>
                    <th>{% trans "Status" %}</th>
                    <th>{% trans "Payment Method" %}</th>
                    <th>{% trans "Actions" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for transaction in transactions %}
                <tr onclick="viewTransaction('{{ transaction.id }}')">
                    <td class="date-cell">
                        {{ transaction.created|date:"M d, Y" }}<br>
                        <small>{{ transaction.created|time:"g:i A" }}</small>
                    </td>
                    <td>
                        <div>{{ transaction.receipt_number|default:transaction.id }}</div>
                        <div class="transaction-id">{{ transaction.stripe_payment_intent_id|truncatechars:20 }}</div>
                    </td>
                    <td class="customer-cell">
                        <div>{{ transaction.customer_name|default:"Walk-in Customer" }}</div>
                        {% if transaction.customer_email %}
                        <small class="text-muted">{{ transaction.customer_email }}</small>
                        {% endif %}
                    </td>
                    <td class="amount-cell {% if transaction.amount < 0 %}amount-negative{% endif %}">
                        ${{ transaction.amount|floatformat:2 }}
                        {% if transaction.refunded_amount and transaction.refunded_amount > 0 %}
                        <br><small class="text-muted">Refunded: ${{ transaction.refunded_amount|floatformat:2 }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge status-{{ transaction.status|lower }}">
                            {{ transaction.get_status_display|default:transaction.status }}
                        </span>
                    </td>
                    <td>
                        {{ transaction.payment_method|default:"Credit Card" }}
                        {% if transaction.card_last_four %}
                        <br><small class="text-muted">****{{ transaction.card_last_four }}</small>
                        {% endif %}
                    </td>
                    <td class="actions-cell">
                        <a href="{% url 'payments:transaction_detail' transaction.id %}" 
                           class="btn-action btn-view" title="{% trans 'View Details' %}">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="{% url 'payments:receipt' %}?transaction={{ transaction.stripe_payment_intent_id }}" 
                           class="btn-action btn-receipt" title="{% trans 'View Receipt' %}">
                            <i class="fas fa-receipt"></i>
                        </a>
                        {% if transaction.status == 'succeeded' and not transaction.refunded_amount %}
                        <button onclick="initiateRefund('{{ transaction.id }}')" 
                                class="btn-action btn-refund" title="{% trans 'Refund' %}">
                            <i class="fas fa-undo"></i>
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="no-transactions">
            <i class="fas fa-inbox fa-3x"></i>
            <h5>{% trans "No Transactions Found" %}</h5>
            <p class="text-muted">{% trans "No payment transactions match your current filters." %}</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Mobile Card Layout (Hidden on Desktop) -->
    <div class="mobile-transaction-cards">
        <div class="mobile-refresh-indicator">
            <i class="fas fa-arrow-down"></i> {% trans "Pull to refresh" %}
        </div>
        {% if transactions %}
        {% for transaction in transactions %}
        <div class="mobile-card">
            <div class="mobile-card-header">
                <div class="mobile-card-amount {% if transaction.amount < 0 %}text-danger{% endif %}">
                    ${{ transaction.amount|floatformat:2 }}
                    {% if transaction.refunded_amount and transaction.refunded_amount > 0 %}
                    <small class="text-warning">(Refund: ${{ transaction.refunded_amount|floatformat:2 }})</small>
                    {% endif %}
                </div>
                <div class="mobile-card-date">
                    {{ transaction.created|date:"M d, Y" }}<br>
                    {{ transaction.created|time:"g:i A" }}
                </div>
            </div>
            
            <div class="mobile-card-details">
                <div class="mobile-card-detail">
                    <strong>{% trans "Transaction ID" %}:</strong><br>
                    {{ transaction.receipt_number|default:transaction.id|truncatechars:12 }}
                </div>
                <div class="mobile-card-detail">
                    <strong>{% trans "Status" %}:</strong><br>
                    <span class="badge badge-{{ transaction.status|lower }}">{{ transaction.get_status_display }}</span>
                </div>
                <div class="mobile-card-detail">
                    <strong>{% trans "Customer" %}:</strong><br>
                    {{ transaction.customer_name|default:"Walk-in Customer" }}
                </div>
                <div class="mobile-card-detail">
                    <strong>{% trans "Payment Method" %}:</strong><br>
                    {{ transaction.payment_method|default:"Credit Card" }}
                </div>
            </div>
            
            <div class="mobile-card-actions">
                <a href="{% url 'payments:transaction_detail' transaction.id %}" class="mobile-card-btn">
                    <i class="fas fa-eye"></i> {% trans "View" %}
                </a>
                <a href="{% url 'payments:receipt' %}?transaction={{ transaction.stripe_payment_intent_id }}" class="mobile-card-btn">
                    <i class="fas fa-receipt"></i> {% trans "Receipt" %}
                </a>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="mobile-card" style="text-align: center; padding: 30px;">
            <i class="fas fa-inbox fa-2x text-muted"></i>
            <h6 class="mt-3">{% trans "No Transactions Found" %}</h6>
            <p class="text-muted mb-0">{% trans "No payment transactions match your current filters." %}</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Pagination (Shared by both layouts) -->
    <div class="pagination-container">
        {% if transactions %}
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page=1" class="page-link">{% trans "First" %}</a>
                <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}" class="page-link">{% trans "Previous" %}</a>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <span class="page-link active">{{ num }}</span>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ num }}" class="page-link">{{ num }}</a>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
                <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}" class="page-link">{% trans "Next" %}</a>
                <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.paginator.num_pages }}" class="page-link">{% trans "Last" %}</a>
            {% endif %}
        </div>
        
        <div class="pagination-info">
            {% trans "Page" %} {{ page_obj.number }} {% trans "of" %} {{ page_obj.paginator.num_pages }} 
            ({{ page_obj.paginator.count }} {% trans "total transactions" %})
        </div>
        {% endif %}
            
    </div>
</div>

<!-- Refund Modal -->
<div class="modal fade" id="refundModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Process Refund" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="refundForm">
                    <div class="mb-3">
                        <label for="refundAmount" class="form-label">{% trans "Refund Amount" %}</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="refundAmount" 
                                   step="0.01" min="0.01" required>
                        </div>
                        <div class="form-text">{% trans "Maximum refundable amount will be shown here" %}</div>
                    </div>
                    <div class="mb-3">
                        <label for="refundReason" class="form-label">{% trans "Reason for Refund" %}</label>
                        <select class="form-select" id="refundReason" required>
                            <option value="">{% trans "Select a reason" %}</option>
                            <option value="requested_by_customer">{% trans "Requested by customer" %}</option>
                            <option value="duplicate">{% trans "Duplicate charge" %}</option>
                            <option value="fraudulent">{% trans "Fraudulent" %}</option>
                            <option value="other">{% trans "Other" %}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="refundNotes" class="form-label">{% trans "Additional Notes" %}</label>
                        <textarea class="form-control" id="refundNotes" rows="3" 
                                  placeholder="{% trans 'Optional notes about this refund' %}"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "Cancel" %}
                </button>
                <button type="button" class="btn btn-danger" onclick="processRefund()">
                    <i class="fas fa-undo"></i> {% trans "Process Refund" %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-submit form on filter changes
    const filterInputs = document.querySelectorAll('.filter-input');
    filterInputs.forEach(input => {
        if (input.type === 'date' || input.tagName === 'SELECT') {
            input.addEventListener('change', function() {
                document.getElementById('historyFilters').submit();
            });
        }
    });
    
    // Set default date range to last 30 days if no filters are set
    const dateFrom = document.getElementById('date_from');
    const dateTo = document.getElementById('date_to');
    
    if (!dateFrom.value && !dateTo.value && !window.location.search.includes('date_from')) {
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
        
        dateFrom.value = thirtyDaysAgo.toISOString().split('T')[0];
        dateTo.value = today.toISOString().split('T')[0];
    }
});

function viewTransaction(transactionId) {
    window.location.href = `/payments/transaction/${transactionId}/`;
}

let currentRefundTransactionId = null;

function initiateRefund(transactionId) {
    currentRefundTransactionId = transactionId;
    
    // Fetch transaction details to populate the form
    fetch(`/payments/api/transaction/${transactionId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('refundAmount').max = data.transaction.refundable_amount;
                document.getElementById('refundAmount').value = data.transaction.refundable_amount;
                
                const modal = new bootstrap.Modal(document.getElementById('refundModal'));
                modal.show();
            } else {
                alert('Error loading transaction details: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading transaction details');
        });
}

function processRefund() {
    if (!currentRefundTransactionId) return;
    
    const amount = document.getElementById('refundAmount').value;
    const reason = document.getElementById('refundReason').value;
    const notes = document.getElementById('refundNotes').value;
    
    if (!amount || !reason) {
        alert('Please fill in all required fields');
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('/payments/api/refund/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({
            transaction_id: currentRefundTransactionId,
            amount: parseFloat(amount),
            reason: reason,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Refund processed successfully');
            window.location.reload();
        } else {
            alert('Error processing refund: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error processing refund');
    });
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('refundModal'));
    modal.hide();
}

// Export functionality
document.addEventListener('DOMContentLoaded', function() {
    const exportLinks = document.querySelectorAll('.btn-export');
    exportLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const format = this.href.split('=')[1];
            const currentParams = new URLSearchParams(window.location.search);
            currentParams.set('export', format);
            window.location.href = `${window.location.pathname}?${currentParams.toString()}`;
        });
    });
    
    // Initialize mobile enhancements
    setupHistoryMobileEnhancements();
});

// Mobile-specific enhancements for payment history
function setupHistoryMobileEnhancements() {
    // Set up touch feedback for interactive elements
    const touchElements = document.querySelectorAll('.mobile-card-btn, .btn-filter, .btn-export, .page-link');
    touchElements.forEach(element => {
        element.addEventListener('touchstart', function(e) {
            this.style.transform = 'scale(0.98)';
            
            // Add haptic feedback if available
            if ('vibrate' in navigator) {
                navigator.vibrate(5);
            }
        }, { passive: true });
        
        element.addEventListener('touchend', function() {
            this.style.transform = '';
        }, { passive: true });
    });
    
    // Mobile pull-to-refresh simulation
    if (window.innerWidth <= 768) {
        let startY = 0;
        let currentY = 0;
        let pullDistance = 0;
        const refreshThreshold = 100;
        const refreshIndicator = document.querySelector('.mobile-refresh-indicator');
        
        document.addEventListener('touchstart', function(e) {
            startY = e.touches[0].clientY;
        }, { passive: true });
        
        document.addEventListener('touchmove', function(e) {
            currentY = e.touches[0].clientY;
            pullDistance = currentY - startY;
            
            if (pullDistance > 20 && window.scrollY === 0) {
                if (refreshIndicator) {
                    refreshIndicator.style.opacity = Math.min(pullDistance / refreshThreshold, 1);
                    if (pullDistance > refreshThreshold) {
                        refreshIndicator.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Release to refresh';
                    } else {
                        refreshIndicator.innerHTML = '<i class="fas fa-arrow-down"></i> Pull to refresh';
                    }
                }
            }
        }, { passive: true });
        
        document.addEventListener('touchend', function(e) {
            if (pullDistance > refreshThreshold && window.scrollY === 0) {
                window.location.reload();
            }
            
            if (refreshIndicator) {
                refreshIndicator.style.opacity = '';
                refreshIndicator.innerHTML = '<i class="fas fa-arrow-down"></i> Pull to refresh';
            }
            
            pullDistance = 0;
        }, { passive: true });
    }
    
    // Mobile swipe actions for transaction cards
    const mobileCards = document.querySelectorAll('.mobile-card');
    mobileCards.forEach(card => {
        let startX = 0;
        let currentX = 0;
        let cardActions = card.querySelector('.mobile-card-actions');
        
        card.addEventListener('touchstart', function(e) {
            startX = e.touches[0].clientX;
        }, { passive: true });
        
        card.addEventListener('touchmove', function(e) {
            currentX = e.touches[0].clientX;
            const diffX = startX - currentX;
            
            // Swipe left to reveal actions
            if (diffX > 50 && cardActions) {
                cardActions.style.transform = 'translateX(0)';
                cardActions.style.opacity = '1';
            } else if (diffX < -20) {
                cardActions.style.transform = 'translateX(100%)';
                cardActions.style.opacity = '0';
            }
        }, { passive: true });
        
        card.addEventListener('touchend', function(e) {
            const diffX = startX - currentX;
            
            if (Math.abs(diffX) < 50 && cardActions) {
                // Reset if swipe wasn't significant
                cardActions.style.transform = '';
                cardActions.style.opacity = '';
            }
        }, { passive: true });
    });
    
    // Enhanced filter handling for mobile
    const filterForm = document.getElementById('historyFilters');
    if (filterForm && window.innerWidth <= 768) {
        // Show loading state during filter submission
        filterForm.addEventListener('submit', function() {
            const submitBtn = this.querySelector('.btn-filter');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Filtering...';
                submitBtn.disabled = true;
            }
        });
    }
    
    // Mobile-optimized date picker handling
    const dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
        // Prevent zoom on focus for iOS
        input.addEventListener('focus', function() {
            if (this.style.fontSize !== '16px') {
                this.style.fontSize = '16px';
            }
        });
        
        // Add clear button for mobile
        if (window.innerWidth <= 768) {
            const clearBtn = document.createElement('span');
            clearBtn.className = 'input-clear-btn';
            clearBtn.innerHTML = '×';
            clearBtn.style.cssText = `
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                cursor: pointer;
                font-size: 18px;
                color: #999;
                z-index: 10;
            `;
            
            clearBtn.addEventListener('click', function() {
                input.value = '';
                input.dispatchEvent(new Event('change'));
            });
            
            const inputWrapper = input.parentNode;
            if (inputWrapper && !inputWrapper.querySelector('.input-clear-btn')) {
                inputWrapper.style.position = 'relative';
                inputWrapper.appendChild(clearBtn);
            }
        }
    });
    
    // Mobile export handling
    const exportLinks = document.querySelectorAll('.btn-export');
    exportLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            // Show loading state for mobile
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
            this.style.pointerEvents = 'none';
            
            // Reset after 3 seconds
            setTimeout(() => {
                this.innerHTML = this.getAttribute('data-original-text') || 'Export';
                this.style.pointerEvents = '';
            }, 3000);
        });
        
        // Store original text
        link.setAttribute('data-original-text', link.textContent.trim());
    });
    
    // Handle orientation changes
    window.addEventListener('orientationchange', function() {
        setTimeout(() => {
            // Recalculate layouts after orientation change
            const tables = document.querySelectorAll('.history-table-container');
            tables.forEach(table => {
                table.style.transform = 'translateX(0)';
            });
        }, 100);
    });
    
    console.log('Mobile enhancements initialized for payment history');
}
</script>
{% endblock %}
