<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}Stripe Payment{% endblock %}</title>
    {% block head %}{% endblock %}
</head>
<body>
    {% block content %}
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-white">
              <h4 class="mb-0">Complete Payment</h4>
              <small class="text-muted">Pay securely with Stripe</small>
            </div>
            <div class="card-body">
              <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>Amount</strong>
                    <div class="h4 m-0">${{ amount|floatformat:2 }}</div>
                  </div>
                  <div class="text-right text-muted">
                    Transaction: <small class="text-monospace">{{ transaction_id }}</small>
                  </div>
                </div>
              </div>

              <form id="payment-form" class="needs-validation" novalidate>
                <div class="form-group">
                  <label for="cardholder-name">Cardholder name</label>
                  <input id="cardholder-name" class="form-control" placeholder="Jane Doe" required />
                  <div class="invalid-feedback">Cardholder name is required.</div>
                </div>

                <div class="form-group">
                  <label for="card-element">Card</label>
                  <div id="card-element" class="p-3 border rounded" style="background:#fff;"></div>
                  <small id="card-errors" class="form-text text-danger mt-2" aria-live="polite"></small>
                </div>

                <div class="form-group mt-4">
                  <button id="submit" class="btn btn-primary btn-block" type="submit">
                    <span id="btn-text">Pay ${{ amount|floatformat:2 }}</span>
                    <span id="btn-spinner" class="spinner-border spinner-border-sm ml-2 d-none" role="status" aria-hidden="true"></span>
                  </button>
                </div>

                <div id="payment-message" class="alert d-none mt-3" role="alert"></div>
              </form>

              <div class="mt-3 text-muted small">You will be redirected after successful payment.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <style>
    /* Local Stripe element tweaks */
    .StripeElement {
      box-sizing: border-box;
      height: 44px;
      padding: 10px 12px;
      border: 1px solid #ced4da;
      border-radius: .25rem;
      background-color: white;
      box-shadow: inset 0 1px 1px rgba(0,0,0,0.02);
    }

    /* Make sure the mounted element inherits size and doesn't overflow */
    #card-element > .__PrivateStripeElement > iframe { 
      height:44px !important; 
      z-index: 1 !important;
    }

    /* Ensure button is above iframe */
    #submit {
      z-index: 10 !important;
      position: relative;
    }
    </style>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
    (function(){
      const stripe = Stripe("{{ STRIPE_PUBLISHABLE_KEY }}");
      const clientSecret = "{{ client_secret }}";

      const elements = stripe.elements({appearance: {theme: 'stripe'}});
      const style = {
        base: {
          color: '#32325d',
          fontFamily: 'Nunito, Roboto, Helvetica, sans-serif',
          fontSmoothing: 'antialiased',
          fontSize: '16px',
          '::placeholder': { color: '#aab7c4' }
        },
        invalid: { color: '#fa755a', iconColor: '#fa755a' }
      };

      const card = elements.create('card', { style });
      card.mount('#card-element');

      const form = document.getElementById('payment-form');
      const submitBtn = document.getElementById('submit');
      const btnText = document.getElementById('btn-text');
      const btnSpinner = document.getElementById('btn-spinner');
      const paymentMessage = document.getElementById('payment-message');
      const cardErrors = document.getElementById('card-errors');

      function showMessage(message, type='info'){
        paymentMessage.classList.remove('d-none','alert-success','alert-danger','alert-info');
        paymentMessage.classList.add('alert-' + (type === 'error' ? 'danger' : (type === 'success' ? 'success' : 'info')));
        paymentMessage.textContent = message;
      }

      function clearMessage(){
        paymentMessage.classList.add('d-none');
        paymentMessage.textContent = '';
      }

      card.on('change', function(event){
        if(event.error){
          cardErrors.textContent = event.error.message;
        } else {
          cardErrors.textContent = '';
        }
      });

      form.addEventListener('submit', async function(ev){
        ev.preventDefault();
        // basic client-side validation
        const nameInput = document.getElementById('cardholder-name');
        if(!nameInput.value.trim()){
          nameInput.classList.add('is-invalid');
          nameInput.focus();
          return;
        } else {
          nameInput.classList.remove('is-invalid');
        }

        // UI: disable button and show spinner
        submitBtn.setAttribute('disabled', 'disabled');
        btnSpinner.classList.remove('d-none');

        clearMessage();

        const {error, paymentIntent} = await stripe.confirmCardPayment(clientSecret, {
          payment_method: {
            card: card,
            billing_details: { name: nameInput.value }
          }
        });

        if(error){
          // Show error and re-enable
          cardErrors.textContent = error.message || 'Payment failed';
          showMessage(error.message || 'Payment failed', 'error');
          submitBtn.removeAttribute('disabled');
          btnSpinner.classList.add('d-none');
          return;
        }

        if(paymentIntent && paymentIntent.status === 'succeeded'){
          showMessage('Payment succeeded â€” redirecting...', 'success');
          // small delay so user sees confirmation
          setTimeout(function(){
            window.location.href = `/complete-stripe-payment/{{ transaction_id }}/`;
          }, 700);
        } else {
          showMessage('Payment processing: ' + (paymentIntent ? paymentIntent.status : ''), 'info');
          submitBtn.removeAttribute('disabled');
          btnSpinner.classList.add('d-none');
        }
      });
    })();
    </script>
    {% endblock %}
</body>
</html>
