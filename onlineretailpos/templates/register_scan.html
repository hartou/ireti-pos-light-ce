{% extends 'base.html' %}
{% load i18n %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Left: Scan input and actions -->
    <div class="col-lg-5 mb-4">
      <div class="card shadow h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h6 class="m-0 font-weight-bold text-primary">{% trans "Scan items" %}</h6>
          <span class="badge badge-pill badge-secondary" id="net-status" data-online="{% trans 'Online' %}" data-offline="{% trans 'Offline' %}">• {% trans "Online" %}</span>
        </div>
        <div class="card-body">
          <form action="" method="POST" class="mb-3" autocomplete="off">
            {% csrf_token %}
            <div class="form-group">
              <label for="id_barcode" class="sr-only">{% trans "Barcode" %}</label>
              {{ form.barcode }}
            </div>
            <div class="form-group d-flex align-items-center">
              <label for="id_qty" class="mr-2 mb-0">{% trans "Qty" %}</label>
              {{ form.qty }}
              <button type="submit" class="btn btn-success ml-3">{% trans "Add" %}</button>
            </div>
          </form>

          <div class="small text-muted">
            <ul class="mb-0">
              <li>{% trans "Scanner: ensure it sends an Enter key after the barcode." %}</li>
              <li>{% trans "Shortcuts: F2 void line, F4 qty×, F9 suspend, F10 recall." %}</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: Cart and tender -->
    <div class="col-lg-7 mb-4">
      <div class="card shadow h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h6 class="m-0 font-weight-bold text-primary">{% trans "Cart" %}</h6>
          <div class="d-flex">
            <a href="/register/suspend_transaction/" class="btn btn-outline-secondary btn-sm mr-2">{% trans "Suspend" %}</a>
            <a href="/register/recall_transaction/" class="btn btn-outline-secondary btn-sm">{% trans "Recall" %}</a>
          </div>
        </div>
        <div class="card-body p-0" style="max-height: 52vh; overflow:auto;">
          <table class="table table-sm mb-0">
            <thead class="thead-light">
              <tr>
                <th class="text-left">{% trans "Item" %}</th>
                <th class="text-right">{% trans "Qty" %}</th>
                <th class="text-right">{% trans "Price" %}</th>
                <th class="text-right">{% trans "Line total" %}</th>
              </tr>
            </thead>
            <tbody>
              {% if cart %}
                {% for code, line in cart.items %}
                  <tr>
                    <td class="text-left"><span class="text-muted">{{ code }}</span><br>{{ line.name }}</td>
                    <td class="text-right">{{ line.quantity }}</td>
                    <td class="text-right">{{ line.price }}</td>
                    <td class="text-right">{{ line.line_total }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="4" class="text-center text-muted py-5">{% trans "Cart is empty. Scan an item to begin." %}</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        <div class="card-footer">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="h6 mb-1 text-muted">{% trans "Subtotal" %}: <strong>{{ total|floatformat:2|default:"0.00" }}</strong></div>
              <div class="small text-muted">{% trans "Tax" %}: {{ tax_total|floatformat:2|default:"0.00" }}</div>
            </div>
            <div class="text-right">
              <div class="h4 m-0">{% trans "Total" %}: <strong>${{ total|floatformat:2|default:"0.00" }}</strong></div>
            </div>
          </div>
          <div class="mt-3 d-flex flex-wrap">
            <a class="btn btn-success mr-2 mb-2" href="/endTransaction/cash/{{ total|default:"0.00" }}">{% trans "Cash" %}</a>
            <a class="btn btn-primary mr-2 mb-2" href="/endTransaction/card/DEBIT_CREDIT">{% trans "Card" %}</a>
            <a class="btn btn-warning mr-2 mb-2" href="/endTransaction/card/STRIPE">
              <i class="fab fa-stripe"></i> {% trans "Stripe" %}
            </a>
            <a class="btn btn-info mr-2 mb-2" href="/endTransaction/card/EBT">{% trans "EBT" %}</a>
            <a class="btn btn-outline-danger ml-auto mb-2" href="/register/cart_clear/">{% trans "Clear" %}</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const input = document.getElementById('id_barcode');
  if (input) {
    input.focus();
    window.addEventListener('keydown', (e) => {
      // Keep focus on the barcode field for wedge scanners
      if (document.activeElement !== input && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) {
        input.focus();
      }
    });
  }
  const badge = document.getElementById('net-status');
  function updateStatus() {
    if (!badge) return;
    const online = navigator.onLine;
    const onlineLabel = badge.dataset.online || 'Online';
    const offlineLabel = badge.dataset.offline || 'Offline';
    badge.textContent = '• ' + (online ? onlineLabel : offlineLabel);
    badge.className = 'badge badge-pill ' + (online ? 'badge-success' : 'badge-warning');
  }
  window.addEventListener('online', updateStatus);
  window.addEventListener('offline', updateStatus);
  updateStatus();
})();
</script>
{% endblock %}
